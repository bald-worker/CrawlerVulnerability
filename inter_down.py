# coding=utf-8
import wget
import os
import gzip
import json
import zipfile


class FromNetGetDate():

    def __init__(self):
        dir_path = os.path.abspath(os.path.dirname(__file__))
        self.downloadpath = os.path.join(dir_path, 'downloads')
        os.makedirs(self.downloadpath, exist_ok=True)

    def download(self, url, save=False):
        filename = wget.detect_filename(url)
        download_file = os.path.join(self.downloadpath, filename)
        try:
            wget.download(url, out=download_file)
        except Exception as e:
            print(e)
            self.download(url, save=False)
        data = gzip.GzipFile(download_file)
        if save:
            with open(download_file.replace('.gz', ''), 'wb') as f:
                f.write(data.read())
        os.remove(download_file)
        return json.loads(data.read())

    def cwe_download(self, url):
        filename = wget.detect_filename(url)
        download_file = os.path.join(self.downloadpath, filename)
        unzip_file = os.path.join(self.downloadpath, filename.replace('.zip', ''))

        wget.download(url, out=download_file)
        zf = zipfile.ZipFile(download_file)
        with open(unzip_file, 'w', encoding="utf-8") as f:
            f.write(zf.read(filename.replace('.zip', '')).decode("utf-8"))
        os.remove(download_file)
        return unzip_file